<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>
    {{ place.display_name }}: OSM ↔ Wikidata
  </title>
  <link rel="shortcut icon" href="{{url_for('static', filename='img/favicon.png')}}" />

<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css')}}">
<link rel="stylesheet" href="{{ url_for('static', filename='bootstrap4/css/bootstrap.css')}}">

<link rel="stylesheet" href="{{ url_for('static', filename='leaflet/leaflet.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='leaflet/MarkerCluster.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='leaflet/MarkerCluster.Default.css') }}">
<style>

body, html {
  height: 100%; margin: 0; padding: 0;
  overflow: hidden;
}
.col {
  position: absolute;
  height: calc(100% - 70px);
  flex: 1;
  padding: 0px;
  margin: 0;
}

.col1 {
  left: 0;
  width: 70%;
  left: 30%;
}

.col2 {
  overflow-y: auto;
  width: 30%;
}

#mapid { height: 100%; }

/* ── Pipeline stage tracker ───────────────────────── */

#stages {
  border: 1px solid #dee2e6;
  border-radius: .375rem;
  padding: 4px 10px;
}

.stage {
  display: flex;
  align-items: flex-start;
  padding: 7px 0;
  font-size: .875rem;
}

.stage + .stage {
  border-top: 1px solid #f0f0f0;
}

.stage-icon {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  border: 2px solid #ced4da;
  flex-shrink: 0;
  margin-right: 10px;
  margin-top: 1px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
}

.stage-body { flex: 1; }

.stage-label { color: #adb5bd; }

/* Active: spinning border */
.stage.active .stage-icon {
  border-color: #007bff;
  border-top-color: transparent;
  animation: spin .8s linear infinite;
}

.stage.active .stage-label {
  color: #343a40;
  font-weight: 600;
}

/* Done: filled green circle with tick */
.stage.done .stage-icon {
  background: #28a745;
  border-color: #28a745;
  color: #fff;
}

.stage.done .stage-label { color: #28a745; }

@keyframes spin { to { transform: rotate(360deg); } }

/* ── Activity (rolling item-level messages) ───────── */

#activity-wrap {
  border-left: 3px solid #007bff;
  padding-left: 8px;
}

#activity-line {
  font-size: .8rem;
  color: #6c757d;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* ── Message log ──────────────────────────────────── */

#message-log { font-size: .78rem; }

.log-entry {
  display: flex;
  gap: 8px;
  padding: 3px 0;
  border-bottom: 1px solid #f8f9fa;
  color: #495057;
}

.log-time {
  color: #adb5bd;
  font-family: monospace;
  font-size: .7rem;
  flex-shrink: 0;
  padding-top: 2px;
}

.log-warn  { color: #856404; }
.log-error { color: #dc3545; }

</style>

</head>

{% from "navbar.html" import navbar_inner with context %}

<body>
<div>

  <nav class="navbar navbar-toggleable-md navbar-expand-lg navbar-dark bg-primary">
    {{ navbar_inner() }}
  </nav>

  <div>
    <div class="col col2 p-3">

      <h5 class="mb-1">{{ place.name }}</h5>
      {% if place.name_extra_detail %}
      <p class="text-muted small mb-3">{{ place.name_extra_detail }}</p>
      {% endif %}

      <!-- Pipeline stage tracker -->
      <div id="stages" class="mb-3">

        <div class="stage" id="stage-wikidata">
          <div class="stage-icon"></div>
          <div class="stage-body">
            <div class="stage-label">Fetch Wikidata items</div>
          </div>
        </div>

        <div class="stage" id="stage-details">
          <div class="stage-icon"></div>
          <div class="stage-body">
            <div class="stage-label">Load item details</div>
          </div>
        </div>

        <div class="stage" id="stage-overpass">
          <div class="stage-icon"></div>
          <div class="stage-body">
            <div class="stage-label">Download OSM data</div>
            <div id="overpass-progress" class="d-none mt-1">
              <div class="progress mt-1" style="height: 4px;">
                <div id="chunk-progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
              </div>
              <small id="chunk-progress-text" class="text-muted"></small>
            </div>
          </div>
        </div>

        <div class="stage" id="stage-matching">
          <div class="stage-icon"></div>
          <div class="stage-body">
            <div class="stage-label">Find matches</div>
          </div>
        </div>

      </div>

      <!-- Rolling activity line (item-level progress) -->
      <div id="activity-wrap" class="mb-2 d-none">
        <div id="activity-line"></div>
      </div>

      <hr class="mt-0 mb-2">

      <!-- Timestamped message log -->
      <div id="message-log"></div>

    </div>
    <div class="col col1">
      <div id="mapid"></div>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='leaflet/leaflet.min.js') }}"></script>
<script src="{{ url_for('static', filename='leaflet/leaflet.markercluster.min.js') }}"></script>

{% set matcher_done_url = place.matcher_done_url(start) %}

<script>
var ws_scheme = {{ ws_scheme | tojson }};
var osm_type = {{ place.osm_type | tojson }};
var osm_id = {{ place.osm_id | tojson }};
var chunk_geojson = [{{ place.geojson_chunks() | join(',') | safe }}];
var matcher_done_url = {{ matcher_done_url | tojson }};
var total_chunks = {{ place.chunk_count() }};
var empty_layers = [];
</script>

<script type="text/javascript" src="{{ url_for('static', filename='js/matcher_map.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/ws.js') }}"></script>

<script src="{{ url_for('static', filename='jquery/jquery.min.js')}}"></script>
<script src="{{ url_for('static', filename='bootstrap4/js/bootstrap.min.js')}}"></script>
<script src="{{ url_for('static', filename='js/app.js')}}"></script>

  {% block script %}{% endblock %}
</body>
</html>
